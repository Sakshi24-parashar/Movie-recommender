import numpy as np
import pandas as pd
import difflib
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import gradio as gr

movies_data = pd.read_csv('/content/movies.csv')

if 'index' not in movies_data.columns:
    movies_data = movies_data.reset_index().rename(columns={'index': 'index'})

selected_features = ['genres', 'keywords', 'tagline', 'cast', 'director']
print("Using features:", selected_features)

for feature in selected_features:
    movies_data[feature] = movies_data[feature].fillna('')

# Combine selected features into a single string
combined_features = (movies_data['genres'] + ' ' +movies_data['keywords'] + ' ' +movies_data['tagline'] + ' ' + movies_data['cast'] + ' ' + movies_data['director'])

vectorizer = TfidfVectorizer()
feature_vectors = vectorizer.fit_transform(combined_features)

similarity = cosine_similarity(feature_vectors)
print("Similarity matrix shape:", similarity.shape)

def recommend_movies(movie_name, top_n=10):

    list_of_all_titles = movies_data['title'].tolist()  # convert entries in 'title' column to a list
    find_close_match = difflib.get_close_matches(movie_name, list_of_all_titles)
    if not find_close_match:
        return [f"No close match found for '{movie_name}'. Please try another movie."]
    close_match = find_close_match[0]
    index_of_the_movie = movies_data[movies_data.title == close_match]['index'].values[0]
    similarity_score = list(enumerate(similarity[index_of_the_movie]))

    sorted_similar_movies = sorted(similarity_score, key=lambda x: x[1], reverse=True)
    recommended_movies = [f"Input matched to: {close_match}", ""]
    i = 0
    for movie in sorted_similar_movies:
        index = movie[0]
        title_from_index = movies_data[movies_data.index == index]['title'].values[0]
        if title_from_index == close_match:
            continue
        recommended_movies.append(f"{i+1}. {title_from_index}")
        i += 1
        if i >= top_n:
            break
    return recommended_movies

############################
# 5. Wrap in a Gradio UI
############################

def gradio_recommender(movie_name, top_n):
    recs = recommend_movies(movie_name, top_n=int(top_n))
    # Join list into a single string for display
    return "\n".join(recs)

with gr.Blocks() as demo:
    gr.Markdown("# ðŸŽ¬ Movie Recommender")
    gr.Markdown("Type a movie name and get similar movie recommendations.")

    with gr.Row():
        movie_input = gr.Textbox(
            label="Enter your favourite movie name",
            placeholder="e.g., Avatar, Inception, Titanic"
        )
        top_n_input = gr.Slider(
            minimum=5,
            maximum=30,
            value=10,
            step=1,
            label="How many recommendations?"
        )

    output = gr.Textbox(label="Movies suggested for you", lines=15)

    recommend_button = gr.Button("Get Recommendations")

    recommend_button.click(
        fn=gradio_recommender,
        inputs=[movie_input, top_n_input],
        outputs=output
    )

demo.launch()
